syntax = "proto3";

package zenao.v1;
option go_package = "github.com/samouraiworld/zenao/backend/zenao/v1;zenaov1";

import "polls/v1/polls.proto";
import "feeds/v1/feeds.proto";

service ZenaoService {
  // USER
  rpc EditUser(EditUserRequest) returns (EditUserResponse);
  rpc GetUserInfo(GetUserInfoRequest) returns (GetUserInfoResponse);

  // EVENT
  rpc CreateEvent(CreateEventRequest) returns (CreateEventResponse);
  rpc CancelEvent(CancelEventRequest) returns (CancelEventResponse);
  rpc EditEvent(EditEventRequest) returns (EditEventResponse);
  rpc GetEventGatekeepers(GetEventGatekeepersRequest)
      returns (GetEventGatekeepersResponse);
  rpc ValidatePassword(ValidatePasswordRequest)
      returns (ValidatePasswordResponse);
  rpc BroadcastEvent(BroadcastEventRequest) returns (BroadcastEventResponse);
  rpc Participate(ParticipateRequest) returns (ParticipateResponse);
  rpc CancelParticipation(CancelParticipationRequest)
      returns (CancelParticipationResponse);
  rpc GetEventTickets(GetEventTicketsRequest) returns (GetEventTicketsResponse);
  rpc Checkin(CheckinRequest) returns (CheckinResponse);
  rpc ExportParticipants(ExportParticipantsRequest)
      returns (ExportParticipantsResponse);

  // COMMUNITY
  rpc CreateCommunity(CreateCommunityRequest)
      returns (CreateCommunityResponse);
  rpc EditCommunity(EditCommunityRequest) returns (EditCommunityResponse);
  rpc GetCommunityAdministrators(GetCommunityAdministratorsRequest)
      returns (GetCommunityAdministratorsResponse);
  rpc JoinCommunity(JoinCommunityRequest) returns (JoinCommunityResponse);
  rpc LeaveCommunity(LeaveCommunityRequest) returns (LeaveCommunityResponse);
  rpc AddEventToCommunity(AddEventToCommunityRequest)
      returns (AddEventToCommunityResponse);
  rpc RemoveEventFromCommunity(RemoveEventFromCommunityRequest)
      returns (RemoveEventFromCommunityResponse);

  // TEAM
  rpc CreateTeam(CreateTeamRequest) returns (CreateTeamResponse);
  rpc EditTeam(EditTeamRequest) returns (EditTeamResponse);

  // XXX: TEMPORARY SWITCH TO WEB2 FIRST
  rpc EntityRoles(EntityRolesRequest) returns (EntityRolesResponse); // -> GetCommunityUserRoles, GetEventUserRoles
  rpc EntitiesWithRoles(EntitiesWithRolesRequest) returns (EntitiesWithRolesResponse); // -> CommunitiesWithUserRole, EventsWithUserRole
  rpc GetCommunity(GetCommunityRequest) returns (GetCommunityResponse);
  rpc ListCommunities(ListCommunitiesRequest) returns (ListCommunitiesResponse);
  rpc ListCommunitiesByEvent(ListCommunitiesByEventRequest) returns (ListCommunitiesByEventResponse);
  rpc ListCommunitiesByUserRoles(ListCommunitiesByUserRolesRequest) returns (ListCommunitiesByUserRolesResponse);
  rpc GetEvent(GetEventRequest) returns (GetEventResponse);
  rpc ListEvents(ListEventsRequest) returns (ListEventsResponse);
  rpc ListEventsByUserRoles(ListEventsByUserRolesRequest) returns (ListEventsByUserRolesResponse);
  rpc GetPost(GetPostRequest) returns (GetPostResponse);
  rpc GetFeedPosts(GetFeedPostsRequest) returns (GetFeedPostsResponse);
  rpc GetChildrenPosts(GetChildrenPostsRequest) returns (GetChildrenPostsResponse);
  rpc GetPoll(GetPollRequest) returns (GetPollResponse);
  rpc GetUsersProfile(GetUsersProfileRequest) returns (GetUsersProfileResponse); // -> BatchProfile

  // FEED
  rpc CreatePoll(CreatePollRequest) returns (CreatePollResponse);
  rpc VotePoll(VotePollRequest) returns (VotePollResponse);
  rpc CreatePost(CreatePostRequest) returns (CreatePostResponse);
  rpc DeletePost(DeletePostRequest) returns (DeletePostResponse);
  rpc ReactPost(ReactPostRequest) returns (ReactPostResponse);
  rpc PinPost(PinPostRequest) returns (PinPostResponse);
  rpc EditPost(EditPostRequest) returns (EditPostResponse);

  // HEALTH
  rpc Health(HealthRequest) returns (HealthResponse);
}

message HealthRequest {}

// XXX: add more fields (e.g. version, commit_hash, ...)
message HealthResponse { bool maintenance = 1; }

message EditUserRequest {
  string display_name = 1;
  string bio = 2;
  string avatar_uri = 3;
}

message EditUserResponse { string id = 1; }

message GetUserInfoRequest {}

message GetUserInfoResponse {
  string user_id = 1;
  string plan = 2;
}

message Profile {
  string user_id = 1;
  string display_name = 2;
  string bio = 3;
  string avatar_uri = 4;
}

message GetUsersProfileRequest {
  repeated string ids = 1;
}

message GetUsersProfileResponse {
  repeated Profile profiles = 1;
}

message GetEventRequest {
  string event_id = 1;
}

message GetEventResponse {
  EventInfo event = 1;
}

message ListEventsRequest {
  uint32 limit = 1;
  uint32 offset = 2;
  int64 from = 3; // unix seconds
  int64 to = 4; // unix seconds
  DiscoverableFilter discoverable_filter = 5; // XXX: should we ensure events non discoverable are listed only if the user is an organizer?
}

message ListEventsResponse {
  repeated EventInfo events = 1;
}

message EventUser {
  EventInfo event = 1;
  repeated string roles = 2; // one of: organizer, gatekeeper, participant
}

message ListEventsByUserRolesRequest {
  string user_id = 1;
  repeated string roles = 2; // one of: organizer, gatekeeper, participant
  uint32 limit = 3;
  uint32 offset = 4;
  int64 from = 5; // unix seconds
  int64 to = 6; // unix seconds
  DiscoverableFilter discoverable_filter = 7; // XXX: should we ensure events non discoverable are listed only if the user is an organizer?
}

message ListEventsByUserRolesResponse {
  repeated EventUser events = 1;
}


message CreateEventRequest {
  string title = 1;
  string description = 2; // markdown
  string image_uri = 3;
  uint64 start_date = 4; // unix seconds
  uint64 end_date = 5; // unix seconds
  double ticket_price = 6; // XXX: use fixed point?
  uint32 capacity = 7;
  EventLocation location = 9;
  string password = 10;
  repeated string organizers = 11;
  repeated string gatekeepers = 12;
  bool discoverable = 13;
  string community_id = 14; // optional
  bool community_email = 15;
}

message CreateEventResponse { string id = 1; }

message CancelEventRequest { string event_id = 1; }

message CancelEventResponse {}

message EditEventRequest {
  string event_id = 1;
  string title = 2;
  string description = 3; // markdown
  string image_uri = 4;
  uint64 start_date = 5; // unix seconds
  uint64 end_date = 6; // unix seconds
  double ticket_price = 7; // XXX: use fixed point?
  uint32 capacity = 8;
  EventLocation location = 9;
  string password = 10;
  bool update_password = 11;
  repeated string organizers = 12;
  repeated string gatekeepers = 13;
  bool discoverable = 14;
  string community_id = 15; // optional
  bool community_email = 16;
}

message EditEventResponse { string id = 1; }

message GetEventGatekeepersRequest { string event_id = 1; }

message GetEventGatekeepersResponse { repeated string gatekeepers = 1; }

message ValidatePasswordRequest {
  string event_id = 1;
  string password = 2;
}

message ValidatePasswordResponse { bool valid = 1; }

message ParticipateRequest {
  string event_id = 1;
  string email = 2;
  repeated string guests = 3;
  string password = 4;
}

message CancelParticipationRequest { string event_id = 1; }

message CancelParticipationResponse {}

message ParticipateResponse { string ticket_secret = 1; }

message BroadcastEventRequest {
  string event_id = 1;
  string message = 2;
  bool attach_ticket = 3;
}

message BroadcastEventResponse {}

message EventLocation {
  string venue_name = 1;
  string instructions = 2; // markdown
  oneof address {
    AddressGeo geo = 3;
    AddressVirtual virtual = 4;
    AddressCustom custom = 5;
  }
}

message AddressVirtual { string uri = 1; }

message AddressGeo {
  string address = 1;
  float lat = 2;
  float lng = 3;
  float size = 4;
}

message AddressCustom {
  string address = 1;
  string timezone = 2; // IANA name
}

message EventPrivacy {
  oneof event_privacy {
    EventPrivacyPublic public = 1;
    EventPrivacyGuarded guarded = 2;
  }
}

message EventPrivacyPublic {}

message EventPrivacyGuarded { string participation_pubkey = 1; }

enum DiscoverableFilter {
  DISCOVERABLE_FILTER_UNSPECIFIED = 0;
  DISCOVERABLE_FILTER_DISCOVERABLE = 1;
  DISCOVERABLE_FILTER_UNDISCOVERABLE = 2;
}

message EventInfo {
  string id = 1;
  string title = 2;
  string description = 3;
  string image_uri = 4;
  repeated string organizers = 5;
  repeated string gatekeepers = 6;
  
  int64 start_date = 7; // unix seconds
  int64 end_date = 8; // unix seconds
  uint32 capacity = 9;
  EventLocation location = 10;
  uint32 participants = 11;
  EventPrivacy privacy = 12;
  uint32 checked_in = 13;
  bool discoverable = 14;
}

message BatchProfileField {
  string type = 1;
  string key = 2;
}

message BatchProfileRequest {
  repeated BatchProfileField fields = 1;
  repeated string addresses = 2;
}

message CreatePollRequest {
  string org_type = 1; // one of: event, community
  string org_id = 2;
  string question = 3;
  repeated string options = 4;
  int64 duration = 5; // unix seconds
  polls.v1.PollKind kind = 6;
}

message CreatePollResponse { string post_id = 1; }

message GetPollRequest { 
  string poll_id = 1;
  string user_id = 2; // optional, to check if the user has voted
 }

message GetPollResponse {
  polls.v1.Poll poll = 1;
}

message VotePollRequest {
  string poll_id = 1;
  string option = 2;
}

message VotePollResponse {}

message CreatePostRequest {
  string org_type = 1; // one of: event, community
  string org_id = 2;
  string content = 3;
  string parent_id = 4;
  repeated string tags = 5;
}

message CreatePostResponse { string post_id = 1; }

message GetPostRequest {
  string post_id = 1;
  string user_id = 2; // optional, to check if the user has reacted
}

message GetPostResponse {
  feeds.v1.PostView post = 1;
}

message GetFeedPostsRequest {
  Entity org = 1;
  uint32 limit = 2;
  uint32 offset = 3;
  repeated string tags = 4;
  string user_id = 5; // optional, to check if the user has reacted
}

message GetFeedPostsResponse {
  repeated feeds.v1.PostView posts = 1;
}

message GetChildrenPostsRequest {
  string parent_id = 1;
  uint32 limit = 2;
  uint32 offset = 3;
  repeated string tags = 4;
  string user_id = 5; // optional, to check if the user has reacted
}

message GetChildrenPostsResponse {
  repeated feeds.v1.PostView posts = 1;
}

message DeletePostRequest { string post_id = 1; }

message DeletePostResponse {}

message ReactPostRequest {
  string post_id = 1;
  string icon = 2;
}

message ReactPostResponse {}

message PinPostRequest {
  string post_id = 1;
  bool pinned = 2;
}

message PinPostResponse {}

message EditPostRequest {
  string post_id = 1;
  string content = 2;
  repeated string tags = 3;
}

message EditPostResponse { string post_id = 1; }

message GetEventTicketsRequest { string event_id = 1; }

message GetEventTicketsResponse { repeated TicketInfo tickets_info = 1; }

message TicketInfo {
  string ticket_secret = 1;
  string user_email = 2;
}

message CheckinRequest {
  string ticket_pubkey = 1;
  string signature = 2;
}

message CheckinResponse {}

message ExportParticipantsRequest { string event_id = 1; }

message ExportParticipantsResponse {
  // XXX: cannot use bytes because not handled in gno-protoc-gen
  string content = 1;
  string filename = 2;
  // XXX: use this to change the mime type without re-generating the proto
  string mime_type = 3;
}

message Entity {
  string entity_type = 1; // one of: user, event
  string entity_id = 2;
}

message EntityRolesRequest {
  Entity org = 1; // one of: community, event
  Entity entity = 2; // one of: user, event
}

message EntityRolesResponse {
  repeated string roles = 1; // one of: administrator, organizer, gatekeeper, member, participant
}

message EntitiesWithRolesRequest {
  Entity org = 1; // one of: community, event
  repeated string roles = 2; // one of: administrator, organizer, gatekeeper, member, participant
}

message EntityWithRoles {
  string entity_type = 1;
  string entity_id = 2;
  repeated string roles = 3;
}

message EntitiesWithRolesResponse {
  repeated EntityWithRoles entities_with_roles = 1;
}

message GetCommunityRequest {
  string community_id = 1;
}

message GetCommunityResponse {
  CommunityInfo community = 1;
}

message CommunityInfo {
  string id = 1;
  string display_name = 2;
  string description = 3;
  string avatar_uri = 4;
  string banner_uri = 5;
  repeated string administrators = 6;
  uint32 count_members = 7;
}

message ListCommunitiesRequest {
  uint32 limit = 1;
  uint32 offset = 2;
}

message ListCommunitiesResponse {
  repeated CommunityInfo communities = 1;
}

message ListCommunitiesByEventRequest {
  string event_id = 1;
  uint32 limit = 2;
  uint32 offset = 3;
}

message ListCommunitiesByEventResponse {
  repeated CommunityInfo communities = 1;
}

message CommunityUser {
  CommunityInfo community = 1;
  repeated string roles = 2; // one of: administrator, member
}

message ListCommunitiesByUserRolesRequest {
  string user_id = 1;
  repeated string roles = 2; // one of: administrator, member
  uint32 limit = 3;
  uint32 offset = 4;
}

message ListCommunitiesByUserRolesResponse {
  repeated CommunityUser communities = 1;
}

message CreateCommunityRequest {
  string display_name = 1;
  string description = 2;
  string avatar_uri = 3;
  string banner_uri = 4;
  repeated string administrators = 5;
}

message CreateCommunityResponse { string community_id = 1; }

message EditCommunityRequest {
  string community_id = 1;
  string display_name = 2;
  string description = 3;
  string avatar_uri = 4;
  string banner_uri = 5;
  repeated string administrators = 6;
}

message EditCommunityResponse {}

message CreateTeamRequest { string display_name = 1; }

message CreateTeamResponse { string team_id = 1; }

message EditTeamRequest {
  string team_id = 1;
  string display_name = 2;
  string bio = 3;
  string avatar_uri = 4;
  repeated string members = 5;
}

message EditTeamResponse {}

message GetCommunityAdministratorsRequest { string community_id = 1; }

message GetCommunityAdministratorsResponse {
  repeated string administrators = 1;
}

message JoinCommunityRequest { string community_id = 1; }

message JoinCommunityResponse {}

message LeaveCommunityRequest { string community_id = 1; }
message LeaveCommunityResponse {}

message AddEventToCommunityRequest {
  string community_id = 1;
  string event_id = 2;
}

message AddEventToCommunityResponse {}

message RemoveEventFromCommunityRequest {
  string community_id = 1;
  string event_id = 2;
}

message RemoveEventFromCommunityResponse {}